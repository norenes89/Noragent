<code from canvas, skipped for brevity>